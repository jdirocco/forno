<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Gestione Magazzino Forno</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">

    <!-- Bootstrap Datepicker CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.10.0/dist/css/bootstrap-datepicker3.min.css">

    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="bi bi-shop"></i> Magazzino Forno</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showShipments()"><i class="bi bi-truck"></i> Spedizioni</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showReturns()"><i class="bi bi-arrow-return-left"></i> Resi</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showShops()"><i class="bi bi-building"></i> Negozi</a>
                    </li>
                    <li class="nav-item" id="usersMenuItem" style="display: none;">
                        <a class="nav-link" href="#" onclick="showUsers()"><i class="bi bi-people"></i> Utenti</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showProducts()"><i class="bi bi-box-seam"></i> Prodotti</a>
                    </li>
                </ul>
                <div class="d-flex flex-column flex-lg-row align-items-center">
                    <span class="navbar-text me-3 mb-2 mb-lg-0" id="userInfo"></span>
                    <button class="btn btn-outline-light btn-sm" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Esci</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <!-- Login Section -->
        <div id="loginSection">
            <div class="row justify-content-center">
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="card shadow">
                        <div class="card-body">
                            <h3 class="card-title text-center mb-4"><i class="bi bi-lock-fill"></i> Login</h3>
                            <form id="loginForm">
                                <div class="mb-3">
                                    <label for="username" class="form-label">Username</label>
                                    <input type="text" class="form-control form-control-lg" id="username" required autocomplete="username">
                                </div>
                                <div class="mb-3">
                                    <label for="password" class="form-label">Password</label>
                                    <input type="password" class="form-control form-control-lg" id="password" required autocomplete="current-password">
                                </div>
                                <button type="submit" class="btn btn-primary btn-lg w-100">Accedi</button>
                            </form>
                            <div id="loginError" class="alert alert-danger mt-3" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="mainContent" style="display: none;">
            <!-- Shipments Section -->
            <div id="shipmentsSection">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                    <h2><i class="bi bi-truck"></i> Spedizioni</h2>
                    <button class="btn btn-primary mt-2 mt-md-0" onclick="showNewShipmentModal()" id="newShipmentBtn">
                        <i class="bi bi-plus-circle"></i> Nuova Spedizione
                    </button>
                </div>
                <div id="shipmentsList"></div>
            </div>

            <!-- Shops Section -->
            <div id="shopsSection" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                    <h2><i class="bi bi-building"></i> Negozi</h2>
                    <button class="btn btn-primary mt-2 mt-md-0" onclick="showNewShopModal()" id="newShopBtn">
                        <i class="bi bi-plus-circle"></i> Nuovo Negozio
                    </button>
                </div>
                <div id="shopsList"></div>
            </div>

            <!-- Products Section -->
            <div id="productsSection" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                    <h2><i class="bi bi-box-seam"></i> Prodotti</h2>
                    <button class="btn btn-primary mt-2 mt-md-0" onclick="showNewProductModal()" id="newProductBtn">
                        <i class="bi bi-plus-circle"></i> Nuovo Prodotto
                    </button>
                </div>
                <div id="productsList"></div>
            </div>

            <!-- Returns Section -->
            <div id="returnsSection" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                    <h2><i class="bi bi-arrow-return-left"></i> Resi</h2>
                    <button class="btn btn-primary mt-2 mt-md-0" onclick="showNewReturnModal()" id="newReturnBtn">
                        <i class="bi bi-plus-circle"></i> Nuovo Reso
                    </button>
                </div>
                <div id="returnsList"></div>
            </div>

            <!-- Users Section (Admin Only) -->
            <div id="usersSection" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                    <h2><i class="bi bi-people"></i> Utenti</h2>
                    <button class="btn btn-primary mt-2 mt-md-0" onclick="showNewUserModal()" id="newUserBtn">
                        <i class="bi bi-plus-circle"></i> Nuovo Utente
                    </button>
                </div>
                <div id="usersList"></div>
            </div>
        </div>
    </div>

    <!-- Shop Modal -->
    <div class="modal fade" id="shopModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="shopModalLabel">Nuovo Negozio</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="shopForm">
                    <div class="modal-body">
                        <input type="hidden" id="shopId">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="shopCode" class="form-label">Codice *</label>
                                <input type="text" class="form-control" id="shopCode" required>
                            </div>
                            <div class="col-md-6">
                                <label for="shopName" class="form-label">Nome *</label>
                                <input type="text" class="form-control" id="shopName" required>
                            </div>
                            <div class="col-12">
                                <label for="shopAddress" class="form-label">Indirizzo *</label>
                                <input type="text" class="form-control" id="shopAddress" required>
                            </div>
                            <div class="col-md-5">
                                <label for="shopCity" class="form-label">Città *</label>
                                <input type="text" class="form-control" id="shopCity" required>
                            </div>
                            <div class="col-md-3">
                                <label for="shopProvince" class="form-label">Provincia</label>
                                <input type="text" class="form-control" id="shopProvince" maxlength="2">
                            </div>
                            <div class="col-md-4">
                                <label for="shopZipCode" class="form-label">CAP</label>
                                <input type="text" class="form-control" id="shopZipCode">
                            </div>
                            <div class="col-md-6">
                                <label for="shopEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="shopEmail">
                            </div>
                            <div class="col-md-6">
                                <label for="shopPhone" class="form-label">Telefono</label>
                                <input type="tel" class="form-control" id="shopPhone">
                            </div>
                            <div class="col-md-6">
                                <label for="shopWhatsApp" class="form-label">WhatsApp</label>
                                <input type="tel" class="form-control" id="shopWhatsApp" placeholder="+39...">
                            </div>
                            <div class="col-md-6">
                                <label for="shopContact" class="form-label">Persona di contatto</label>
                                <input type="text" class="form-control" id="shopContact">
                            </div>
                            <div class="col-12">
                                <label for="shopNotes" class="form-label">Note</label>
                                <textarea class="form-control" id="shopNotes" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                        <button type="submit" class="btn btn-primary">Salva</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalLabel">Nuovo Prodotto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="productForm">
                    <div class="modal-body">
                        <input type="hidden" id="productId">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="productCode" class="form-label">Codice *</label>
                                <input type="text" class="form-control" id="productCode" required>
                            </div>
                            <div class="col-md-6">
                                <label for="productName" class="form-label">Nome *</label>
                                <input type="text" class="form-control" id="productName" required>
                            </div>
                            <div class="col-12">
                                <label for="productDescription" class="form-label">Descrizione</label>
                                <textarea class="form-control" id="productDescription" rows="2"></textarea>
                            </div>
                            <div class="col-md-6">
                                <label for="productCategory" class="form-label">Categoria *</label>
                                <select class="form-select" id="productCategory" required>
                                    <option value="">Seleziona...</option>
                                    <option value="BREAD">Pane</option>
                                    <option value="PASTRY">Pasticceria</option>
                                    <option value="PIZZA">Pizza</option>
                                    <option value="FOCACCIA">Focaccia</option>
                                    <option value="COOKIE">Biscotti</option>
                                    <option value="CAKE">Torte</option>
                                    <option value="OTHER">Altro</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="productUnit" class="form-label">Unità *</label>
                                <input type="text" class="form-control" id="productUnit" placeholder="kg, pz, ecc." required>
                            </div>
                            <div class="col-md-6">
                                <label for="productPrice" class="form-label">Prezzo Unitario (€) *</label>
                                <input type="number" step="0.01" min="0" class="form-control" id="productPrice" required>
                            </div>
                            <div class="col-12">
                                <label for="productNotes" class="form-label">Note</label>
                                <textarea class="form-control" id="productNotes" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                        <button type="submit" class="btn btn-primary">Salva</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Shipment Modal -->
    <div class="modal fade" id="shipmentModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nuova Spedizione</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="shipmentForm">
                    <div class="modal-body">
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="shipmentShop" class="form-label">Negozio *</label>
                                <select class="form-select" id="shipmentShop" required></select>
                            </div>
                            <div class="col-md-6">
                                <label for="shipmentDate" class="form-label">Data Spedizione *</label>
                                <input type="text" class="form-control datepicker" id="shipmentDate" required placeholder="Seleziona data">
                            </div>
                            <div class="col-12">
                                <label for="shipmentNotes" class="form-label">Note</label>
                                <textarea class="form-control" id="shipmentNotes" rows="2"></textarea>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6><i class="bi bi-box-seam"></i> Prodotti</h6>
                            <button type="button" class="btn btn-sm btn-success" onclick="addShipmentItem()">
                                <i class="bi bi-plus-circle"></i> Aggiungi Prodotto
                            </button>
                        </div>
                        <div id="shipmentItems"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                        <button type="submit" class="btn btn-primary">Crea Spedizione</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Shipment Details Modal -->
    <div class="modal fade" id="shipmentDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-file-text"></i> Dettagli Spedizione</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="shipmentDetailsBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Return Modal -->
    <div class="modal fade" id="returnModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="returnModalLabel">Nuovo Reso</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="returnForm">
                    <div class="modal-body">
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="returnShipment" class="form-label">Spedizione *</label>
                                <select class="form-select" id="returnShipment" onchange="onShipmentSelected()" required>
                                    <option value="">Seleziona una spedizione...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="returnDate" class="form-label">Data Reso *</label>
                                <input type="text" class="form-control datepicker" id="returnDate" required placeholder="Seleziona data">
                            </div>
                            <input type="hidden" id="returnShopId">
                            <div class="col-12">
                                <label for="returnReason" class="form-label">Motivo Generale</label>
                                <textarea class="form-control" id="returnReason" rows="2"
                                          placeholder="Descrivi il motivo generale del reso..."></textarea>
                            </div>
                            <div class="col-12">
                                <label for="returnNotes" class="form-label">Note</label>
                                <textarea class="form-control" id="returnNotes" rows="2"></textarea>
                            </div>
                        </div>

                        <div class="mb-3">
                            <h6><i class="bi bi-box-seam"></i> Articoli da Rendere</h6>
                            <p class="text-muted small">Seleziona la spedizione per vedere gli articoli disponibili per il reso</p>
                        </div>
                        <div id="returnItems"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                        <button type="submit" class="btn btn-primary">Crea Reso</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Return Details Modal -->
    <div class="modal fade" id="returnDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-arrow-return-left"></i> Dettagli Reso</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="returnDetailsBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- jQuery (required for DataTables and Datepicker) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

    <!-- Bootstrap Datepicker JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.10.0/dist/js/bootstrap-datepicker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.10.0/dist/locales/bootstrap-datepicker.it.min.js"></script>

    <script src="/js/app.js"></script>
    <script>
        // Initialize datepickers when document is ready
        $(document).ready(function() {
            // Initialize all date inputs with datepicker
            initializeDatepickers();
        });

        function initializeDatepickers() {
            $('.datepicker').datepicker({
                format: 'yyyy-mm-dd',
                language: 'it',
                autoclose: true,
                todayHighlight: true,
                orientation: 'bottom auto'
            });

            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            const shipmentDate = document.getElementById('shipmentDate');
            const returnDate = document.getElementById('returnDate');
            if (shipmentDate && !shipmentDate.value) shipmentDate.value = today;
            if (returnDate && !returnDate.value) returnDate.value = today;
        }
    </script>

    <!-- User Modal (Create/Edit) -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalTitle">Nuovo Utente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <input type="hidden" id="userId">
                        <div class="mb-3">
                            <label for="userUsername" class="form-label">Username *</label>
                            <input type="text" class="form-control" id="userUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="userPassword" class="form-label">Password <span id="passwordOptionalLabel" style="display:none;">(opzionale per modifica)</span></label>
                            <input type="password" class="form-control" id="userPassword">
                        </div>
                        <div class="mb-3">
                            <label for="userFullName" class="form-label">Nome Completo *</label>
                            <input type="text" class="form-control" id="userFullName" required>
                        </div>
                        <div class="mb-3">
                            <label for="userEmail" class="form-label">Email *</label>
                            <input type="email" class="form-control" id="userEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="userPhone" class="form-label">Telefono</label>
                            <input type="text" class="form-control" id="userPhone">
                        </div>
                        <div class="mb-3">
                            <label for="userWhatsapp" class="form-label">WhatsApp</label>
                            <input type="text" class="form-control" id="userWhatsapp">
                        </div>
                        <div class="mb-3">
                            <label for="userRole" class="form-label">Ruolo *</label>
                            <select class="form-select" id="userRole" required>
                                <option value="ADMIN">Amministratore</option>
                                <option value="ACCOUNTANT">Contabile</option>
                                <option value="DRIVER">Autista</option>
                                <option value="SHOP">Negozio</option>
                            </select>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="userActive" checked>
                            <label class="form-check-label" for="userActive">
                                Attivo
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-primary" onclick="saveUser()">Salva</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
